<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>教务信息站点 - SSO 演示</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      body { font-family: "Segoe UI", sans-serif; margin: 0; background: linear-gradient(135deg,#f2f4ff,#e6f3ff); color:#1f2937; }
      header { padding: 16px 24px; background: #0f172a; color: #e2e8f0; }
      main { padding: 24px; max-width: 960px; margin: auto; }
      .card { background: #fff; border-radius: 12px; box-shadow: 0 8px 18px rgba(15,23,42,0.08); padding: 16px 20px; margin-bottom: 16px; }
      input, button { padding: 8px 10px; font-size: 14px; border-radius: 8px; border: 1px solid #d9e0e8; }
      button { background: #2563eb; color: #fff; border: none; cursor: pointer; }
      button.secondary { background: #0ea5e9; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
      .badge { background: #e0f2fe; color: #0ea5e9; padding: 2px 8px; border-radius: 6px; font-size: 12px; }
      pre { background: #0b1220; color: #cbd5e1; padding: 12px; border-radius: 8px; overflow: auto; }
    </style>
  </head>
  <body>
    <header>
      <h2>教务信息站点 · OAuth2.0 SSO</h2>
    </header>
    <main id="app">
      <div class="card">
        <h3>1) 统一身份认证 (SSO Cookie)</h3>
        <p>当前状态：<span class="badge" v-if="loggedIn">已登录</span><span v-else>未登录</span></p>
        <button @click="goLogin">前往登录（302 到统一认证）</button>
        <button class="secondary" @click="logout" :disabled="loading">退出本系统</button>
      </div>

      <div class="card">
        <h3>2) 访问受保护资源</h3>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <button @click="loadCourses" :disabled="!loggedIn || loading">获取课程列表</button>
          <button @click="loadGrades" :disabled="!loggedIn || loading">获取成绩</button>
        </div>
        <h4>结果</h4>
        <pre>{{ JSON.stringify(result, null, 2) }}</pre>
      </div>
    </main>

    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            authBase: "https://auth.localhost:5000",
            apiBase: "https://academic.localhost:5001",
            loggedIn: false,
            result: {},
            loading: false,
          };
        },
        mounted() {
          this.checkStatus();
        },
        methods: {
          goLogin() {
            window.location.href = `${this.apiBase}/session/login`;
          },
          async checkStatus() {
            const res = await fetch(`${this.apiBase}/session/status`, { credentials: "include" });
            this.loggedIn = res.ok;
          },
          async loadCourses() {
            await this.fetchProtected("/courses");
          },
          async loadGrades() {
            await this.fetchProtected("/grades");
          },
          async fetchProtected(path) {
            if (!this.loggedIn) {
              alert("请先登录");
              return;
            }
            this.loading = true;
            try {
              const res = await fetch(`${this.apiBase}${path}`, {
                credentials: "include",
              });
              const data = await res.json();
              this.result = data;
              if (!res.ok) throw new Error(JSON.stringify(data));
            } catch (e) {
              alert(e.message);
            } finally {
              this.loading = false;
            }
          },
          logout() {
            fetch(`${this.apiBase}/session/logout`, { method: "POST", credentials: "include" });
            this.loggedIn = false;
          },
          toast(msg) {
            console.log(msg);
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
