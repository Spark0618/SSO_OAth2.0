<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>我的信息 - 教务站点</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      body { font-family: "Segoe UI", sans-serif; margin:0; background: linear-gradient(135deg,#f2f4ff,#e6f3ff); color:#1f2937; }
      header { display:flex; align-items:center; justify-content:space-between; padding: 16px 24px; background:#0f172a; color:#e2e8f0; }
      main { max-width: 900px; margin: 24px auto; padding: 0 16px 24px; }
      .card { background:#fff; border-radius:16px; box-shadow: 0 8px 18px rgba(15,23,42,0.08); padding:18px 20px; margin-bottom:16px; }
      .card h3 { margin-top:0; }
      .badge { background:#e0f2fe; color:#0ea5e9; padding:4px 10px; border-radius:999px; font-size:12px; }
      .row { display:flex; flex-wrap:wrap; gap:12px; }
      .item { min-width:240px; background:#f8fafc; padding:10px 12px; border-radius:10px; }
      a { color:#2563eb; text-decoration:none; }
    </style>
  </head>
  <body>
    <div id="app">
      <header>
        <div>
          <h2 style="margin:0;">我的信息</h2>
          <p style="margin:4px 0 0 0; color:#cbd5e1;">来自 academic-api /profile</p>
        </div>
        <div>
          <a href="academic.html">← 返回主页</a>
        </div>
      </header>
      <main>
        <div class="card">
          <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <h3 style="margin:0;">身份状态</h3>
            <span class="badge">{{ statusText }}</span>
          </div>
        </div>

        <div class="card">
          <h3>个人信息</h3>
          <div class="row">
            <div class="item">姓名：<input v-model="profile.personal.name" /></div>
            <div class="item">学号/工号：<input v-model="profile.personal.student_id" /></div>
          </div>
          <button style="margin-top:10px;" @click="saveProfile">保存信息</button>
        </div>

        <div class="card">
          <h3>教职信息</h3>
          <div class="row">
            <div class="item">年级/职称：<input v-model="profile.enrollment.grade" /></div>
            <div class="item">学院/部门：<input v-model="profile.enrollment.college" /></div>
            <div class="item">专业/岗位：<input v-model="profile.enrollment.major" /></div>
          </div>
          <button style="margin-top:10px;" @click="saveProfile">保存信息</button>
        </div>

        <div class="card">
          <h3>修改密码</h3>
          <div class="row">
            <div class="item">原密码：<input type="password" v-model="oldPassword" /></div>
            <div class="item">新密码：<input type="password" v-model="newPassword" /></div>
          </div>
          <button style="margin-top:10px;" @click="changePassword">修改密码</button>
        </div>
      </main>
    </div>

    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            apiBase: "https://academic.localhost:5001",
            profile: {
              personal: { name: "-", student_id: "-" },
              enrollment: { grade: "-", college: "-", major: "-", progress: "-" },
            },
            statusText: "加载中...",
            oldPassword: "",
            newPassword: "",
          };
        },
        mounted() {
          this.loadProfile();
        },
        methods: {
          async loadProfile() {
            try {
              const res = await fetch(`${this.apiBase}/profile`, { credentials: "include" });
              const data = await res.json();
              if (!res.ok) throw new Error(data.error || "未登录");
              this.profile = data.profile || this.profile;
              this.statusText = `已登录：${data.user || "未知用户"}`;
            } catch (e) {
              this.statusText = e.message || "获取失败";
            }
          },
          async saveProfile() {
            try {
              const res = await fetch(`${this.apiBase}/profile`, {
                method: "PUT",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  name: this.profile.personal.name,
                  student_id: this.profile.personal.student_id,
                  gender: this.profile.personal.gender,
                  hometown: this.profile.personal.hometown,
                  grade: this.profile.enrollment.grade,
                  college: this.profile.enrollment.college,
                  major: this.profile.enrollment.major,
                  title: this.profile.enrollment.grade,
                  department: this.profile.enrollment.college,
                }),
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data.error || "保存失败");
              alert("已保存");
            } catch (e) {
              alert(e.message);
            }
          },
          async changePassword() {
            if (!this.oldPassword || !this.newPassword) {
              alert("请填写原密码和新密码");
              return;
            }
            try {
              const res = await fetch(`${this.apiBase}/profile/password`, {
                method: "POST",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ old_password: this.oldPassword, new_password: this.newPassword }),
              });
              const data = await res.json();
              if (!res.ok) throw new Error(data.error || "修改失败");
              alert("密码已修改");
              this.oldPassword = "";
              this.newPassword = "";
            } catch (e) {
              alert(e.message);
            }
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
