<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>云盘站点 - SSO 演示</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      body { font-family: "Segoe UI", sans-serif; margin:0; background:#0f172a; color:#e2e8f0; }
      header { padding: 16px 24px; background:#0b1220; }
      main { padding: 24px; max-width: 960px; margin:auto; }
      .card { background: #111827; border: 1px solid #1e293b; border-radius: 12px; padding: 16px 20px; margin-bottom: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.35); }
      input, button { padding: 8px 10px; font-size: 14px; border-radius: 8px; border: 1px solid #1e293b; }
      input { background:#0b1220; color:#e2e8f0; }
      button { background:#10b981; color:#0b1220; border:none; cursor:pointer; }
      button.secondary { background:#22d3ee; }
      button:disabled { opacity:0.6; cursor: not-allowed; }
      .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px; }
      ul { list-style:none; padding:0; }
      li { padding:8px 0; border-bottom:1px dashed #1e293b; }
    </style>
  </head>
  <body>
    <header>
      <h2>云盘站点 · OAuth2.0 SSO</h2>
    </header>
    <main id="app">
      <div class="card">
        <h3>登录 & 授权</h3>
        <p>当前状态：{{ loggedIn ? "已登录" : "未登录" }}</p>
        <button class="secondary" @click="goLogin">前往统一认证（302）</button>
        <button @click="logout">退出</button>
      </div>

      <div class="card">
        <h3>云盘文件</h3>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <button @click="listFiles" :disabled="!loggedIn || loading">列出文件</button>
          <button @click="uploadFile" :disabled="!loggedIn || loading">模拟上传</button>
          <button @click="logout">清除令牌</button>
        </div>
        <ul>
          <li v-for="f in files" :key="f.name">
            {{ f.name }} — {{ f.size }} — {{ f.uploaded_at }}
          </li>
        </ul>
      </div>
    </main>

    <script>
          const { createApp } = Vue;
          createApp({
            data() {
              return {
                authBase: "https://auth.localhost:5000",
                apiBase: "https://cloud.localhost:5002",
                loggedIn: false,
                files: [],
                loading: false,
              };
            },
            mounted() {
              this.checkStatus();
            },
            methods: {
              goLogin() {
                window.location.href = `${this.apiBase}/session/login`;
              },
              async checkStatus() {
                const res = await fetch(`${this.apiBase}/session/status`, { credentials: "include" });
                this.loggedIn = res.ok;
              },
              async listFiles() {
                if (!this.loggedIn) { alert("请先登录"); return; }
                const res = await fetch(`${this.apiBase}/files`, {
                  credentials: "include",
                });
                const data = await res.json();
                if (!res.ok) { alert(JSON.stringify(data)); return; }
                this.files = data.files || [];
              },
              async uploadFile() {
                if (!this.loggedIn) { alert("请先登录"); return; }
                const res = await fetch(`${this.apiBase}/files`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  credentials: "include",
                  body: JSON.stringify({ name: `report-${Date.now()}.pdf`, size: "4KB" }),
                });
                const data = await res.json();
                if (!res.ok) { alert(JSON.stringify(data)); return; }
                this.files = data.files || [];
              },
              logout() {
                fetch(`${this.apiBase}/session/logout`, { method: "POST", credentials: "include" });
                this.loggedIn = false;
              },
            },
          }).mount("#app");
    </script>
  </body>
</html>
