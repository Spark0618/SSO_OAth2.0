<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>äº‘ç›˜ç«™ç‚¹ - SSO æ¼”ç¤º</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      :root {
        --primary-color: #6A8CAF;
        --primary-light: #8CADD6;
        --secondary-color: #A8D5BA;
        --accent-color: #F4A261;
        --background-color: #F8F9FA;
        --card-bg: #FFFFFF;
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --text-primary: #2C3E50;
        --text-secondary: #7F8C8D;
        --border-color: #E0E6ED;
        --success-color: #2ECC71;
        --warning-color: #F39C12;
        --hover-shadow: 0 6px 24px rgba(0, 0, 0, 0.12);
        --transition-speed: 0.3s;
      }

      body {
        font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
        margin: 0;
        background: var(--background-color);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
      }

      header {
        padding: 20px 32px;
        background: var(--card-bg);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border-bottom: 1px solid var(--border-color);
      }

      header h2 {
        margin: 0;
        color: var(--primary-color);
        font-weight: 600;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      header h2::before {
        content: "â˜ï¸";
        font-size: 1.8rem;
      }

      main {
        padding: 32px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .cards-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 24px;
        margin-bottom: 32px;
      }

      .card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 28px;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--border-color);
        transition: all var(--transition-speed) ease;
      }

      .card:hover {
        box-shadow: var(--hover-shadow);
        transform: translateY(-2px);
      }

      .card h3 {
        margin: 0 0 20px 0;
        color: var(--primary-color);
        font-size: 1.3rem;
        font-weight: 600;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--secondary-color);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .card h3::before {
        content: "";
        width: 6px;
        height: 24px;
        background: var(--primary-color);
        border-radius: 3px;
      }

      .status-container {
        background: linear-gradient(135deg, rgba(106, 140, 175, 0.1), rgba(168, 213, 186, 0.1));
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        border: 1px solid rgba(106, 140, 175, 0.2);
      }

      .status-row {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .status-row:last-child {
        margin-bottom: 0;
      }

      .status-label {
        font-weight: 500;
        color: var(--text-secondary);
        min-width: 100px;
      }

      .status-value {
        font-weight: 600;
        color: var(--text-primary);
      }

      .status-value.logged-in {
        color: var(--success-color);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .status-value.logged-in::before {
        content: "âœ“";
        background: var(--success-color);
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }

      .status-value.logged-out {
        color: var(--warning-color);
      }

      .button-group {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 20px;
      }

      button {
        padding: 12px 24px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        transition: all var(--transition-speed) ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-width: 140px;
      }

      button.primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
        box-shadow: 0 4px 12px rgba(106, 140, 175, 0.3);
      }

      button.primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(106, 140, 175, 0.4);
      }

      button.secondary {
        background: linear-gradient(135deg, var(--secondary-color), #C5E8D4);
        color: var(--text-primary);
        box-shadow: 0 4px 12px rgba(168, 213, 186, 0.3);
      }

      button.secondary:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(168, 213, 186, 0.4);
      }

      button.accent {
        background: linear-gradient(135deg, var(--accent-color), #F7C291);
        color: white;
        box-shadow: 0 4px 12px rgba(244, 162, 97, 0.3);
      }

      button.accent:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(244, 162, 97, 0.4);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
      }

      .operations-panel {
        background: linear-gradient(135deg, rgba(248, 249, 250, 0.8), rgba(255, 255, 255, 0.9));
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        border: 1px solid var(--border-color);
      }

      .operations-grid {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }

      .file-upload-area {
        background: rgba(168, 213, 186, 0.1);
        border: 2px dashed var(--secondary-color);
        border-radius: 12px;
        padding: 24px;
        transition: all var(--transition-speed) ease;
        text-align: center;
      }

      .file-upload-area:hover {
        background: rgba(168, 213, 186, 0.15);
        border-color: var(--primary-color);
      }

      .file-input-wrapper {
        position: relative;
        margin-bottom: 16px;
        display: inline-block;
      }

      .file-input-wrapper input[type="file"] {
        position: absolute;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
      }

      .file-input-label {
        display: inline-block;
        padding: 16px 32px;
        background: var(--card-bg);
        border-radius: 10px;
        border: 2px solid var(--primary-color);
        color: var(--primary-color);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-speed) ease;
        min-width: 200px;
        text-align: center;
      }

      .file-input-label:hover {
        background: rgba(106, 140, 175, 0.1);
      }

      .selected-file {
        margin: 16px 0;
        color: var(--text-secondary);
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        word-break: break-word;
        text-align: center;
        min-height: 24px;
      }

      .selected-file::before {
        content: "ğŸ“„";
      }

      .upload-button-wrapper {
        display: flex;
        justify-content: center;
        margin-top: 8px;
      }

      .upload-button-wrapper button {
        min-width: 200px;
      }

      .file-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .file-item {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
        border: 1px solid var(--border-color);
        transition: all var(--transition-speed) ease;
        position: relative;
      }

      .file-item:hover {
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
      }

      .file-item::before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 60%;
        background: var(--primary-color);
        border-radius: 2px;
        opacity: 0;
        transition: opacity var(--transition-speed) ease;
      }

      .file-item:hover::before {
        opacity: 1;
      }

      .file-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }

      .file-name {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .file-name::before {
        content: "ğŸ“";
        font-size: 18px;
      }

      .file-tags {
        display: flex;
        gap: 8px;
      }

      .tag {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .tag.encrypted {
        background: rgba(244, 162, 97, 0.15);
        color: var(--accent-color);
        border: 1px solid rgba(244, 162, 97, 0.3);
      }

      .tag.binary {
        background: rgba(106, 140, 175, 0.15);
        color: var(--primary-color);
        border: 1px solid rgba(106, 140, 175, 0.3);
      }

      .file-meta {
        display: flex;
        gap: 20px;
        color: var(--text-secondary);
        font-size: 14px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .meta-item::before {
        font-size: 14px;
      }

      .file-size::before {
        content: "ğŸ“";
      }

      .upload-time::before {
        content: "ğŸ•’";
      }

      .share-info {
        background: rgba(168, 213, 186, 0.1);
        border-radius: 8px;
        padding: 12px;
        margin: 12px 0;
        border-left: 3px solid var(--secondary-color);
      }

      .share-url {
        font-size: 13px;
        color: var(--primary-color);
        word-break: break-all;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .share-url::before {
        content: "ğŸ”—";
      }

      .share-expiry {
        font-size: 12px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .share-expiry::before {
        content: "â°";
      }

      .file-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
      }

      .empty-state::before {
        content: "ğŸ“";
        font-size: 48px;
        display: block;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(106, 140, 175, 0.3);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      @media (max-width: 768px) {
        main {
          padding: 20px;
        }
        
        .cards-container {
          grid-template-columns: 1fr;
        }
        
        .operations-grid {
          flex-direction: column;
          align-items: center;
        }
        
        .operations-grid button {
          width: 100%;
          max-width: 300px;
        }
        
        .button-group {
          flex-direction: column;
        }
        
        button {
          width: 100%;
        }
        
        .file-input-label,
        .upload-button-wrapper button {
          min-width: 100%;
          max-width: 300px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h2>äº‘ç›˜ç«™ç‚¹ Â· OAuth2.0 SSO æ¼”ç¤º</h2>
    </header>
    <main id="app">
      <div class="cards-container">
        <!-- ç™»å½•å¡ç‰‡ -->
        <div class="card">
          <h3>ç™»å½• & æˆæƒ</h3>
          <div class="status-container">
            <div class="status-row">
              <span class="status-label">å½“å‰çŠ¶æ€ï¼š</span>
              <span class="status-value" :class="loggedIn ? 'logged-in' : 'logged-out'">
                {{ loggedIn ? "å·²ç™»å½•" : "æœªç™»å½•" }}
              </span>
            </div>
            <div class="status-row" v-if="username">
              <span class="status-label">å½“å‰ç”¨æˆ·ï¼š</span>
              <span class="status-value">{{ username }}</span>
            </div>
          </div>
          <div class="button-group">
            <button class="primary" @click="goLogin">
              <span>å‰å¾€ç»Ÿä¸€è®¤è¯</span>
              <span>â†’</span>
            </button>
            <button class="accent" @click="logout" :disabled="!loggedIn">
              <span>é€€å‡ºç™»å½•</span>
              <span>ğŸšª</span>
            </button>
          </div>
        </div>

        <!-- äº‘ç›˜å¡ç‰‡ -->
        <div class="card">
          <h3>äº‘ç›˜æ–‡ä»¶ç®¡ç†</h3>
          
          <!-- æ“ä½œåŒº -->
          <div class="operations-panel">
            <div class="operations-grid">
              <button class="primary" @click="listFiles" :disabled="!loggedIn || loading">
                <span v-if="loading" class="loading"></span>
                <span v-else>ğŸ“‹ åˆ—å‡ºæ–‡ä»¶</span>
              </button>
              <button class="secondary" @click="uploadDemo" :disabled="!loggedIn || loading">
                <span v-if="loading" class="loading"></span>
                <span v-else>â¬†ï¸ æ¨¡æ‹Ÿä¸Šä¼ </span>
              </button>
            </div>
            
            <div class="file-upload-area">
              <div class="file-input-wrapper">
                <input type="file" @change="onFileChange" id="fileInput" />
                <label for="fileInput" class="file-input-label">é€‰æ‹©æ–‡ä»¶</label>
              </div>
              <div class="selected-file" v-if="realFileName">
                {{ realFileName }}
              </div>
              <div class="upload-button-wrapper">
                <button class="accent" @click="uploadReal" :disabled="!loggedIn || loading || !realFile">
                  <span v-if="loading" class="loading"></span>
                  <span v-else>ğŸš€ ä¸Šä¼ çœŸå®æ–‡ä»¶</span>
                </button>
              </div>
            </div>
          </div>

          <div v-if="!files.length && !loading" class="empty-state">
            å½“å‰æš‚æ— æ–‡ä»¶ï¼Œå¯å…ˆç‚¹å‡»"æ¨¡æ‹Ÿä¸Šä¼ "æˆ–é€‰æ‹©æ–‡ä»¶å"ä¸Šä¼ çœŸå®æ–‡ä»¶"
          </div>

          <ul class="file-list" v-else-if="files.length">
            <li class="file-item" v-for="f in files" :key="f.id || f.name">
              <div class="file-header">
                <div class="file-name">{{ f.name }}</div>
                <div class="file-tags">
                  <span v-if="f.encrypted" class="tag encrypted">åŠ å¯†</span>
                  <span v-if="f.is_binary" class="tag binary">çœŸå®æ–‡ä»¶</span>
                </div>
              </div>
              
              <div class="file-meta">
                <div class="meta-item file-size">{{ f.size }}</div>
                <div class="meta-item upload-time">{{ f.uploaded_at }}</div>
              </div>
              
              <div class="share-info" v-if="f.share_token">
                <div class="share-url">
                  <a :href="shareUrlFor(f)" target="_blank" style="color: inherit; text-decoration: none;">
                    {{ shareUrlFor(f) }}
                  </a>
                </div>
                <div class="share-expiry" v-if="f.share_expires_at">
                  æœ‰æ•ˆæœŸè‡³ {{ f.share_expires_at }}
                </div>
                <div class="share-expiry" v-if="f.share_password">
                  å¯†ç ï¼š{{ f.share_password }}
                </div>
              </div>
              
              <div class="file-actions">
                <button class="secondary" @click="shareFile(f)" :disabled="!loggedIn || loading" style="font-size: 14px; padding: 8px 16px;">
                  <span>ğŸ”— è®¾ç½®åˆ†äº«</span>
                </button>
                <button class="primary" v-if="f.is_binary" @click="downloadFile(f)" 
                        :disabled="!loggedIn || loading" style="font-size: 14px; padding: 8px 16px;">
                  <span>â¬‡ï¸ ä¸‹è½½</span>
                </button>
              </div>
            </li>
          </ul>
          
          <div v-if="loading && files.length === 0" class="empty-state">
            <div class="loading" style="width: 30px; height: 30px; margin: 0 auto 16px;"></div>
            åŠ è½½ä¸­...
          </div>
        </div>
      </div>
    </main>

    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            authBase: "https://auth.localhost:5000",
            apiBase: "https://cloud.localhost:5002",
            frontendBase: "https://cloud.localhost:4176",
            loggedIn: false,
            username: null,
            files: [],
            loading: false,
            realFile: null,
            realFileName: "",
          };
        },
        mounted() {
          this.checkStatus();
        },
        methods: {
          goLogin() {
            window.location.href = `${this.apiBase}/session/login`;
          },
          async checkStatus() {
            try {
              const res = await fetch(`${this.apiBase}/session/status`, { credentials: "include" });
              this.loggedIn = res.ok;
            } catch (e) {
              console.error(e);
              this.loggedIn = false;
            }
          },
          async listFiles() {
            if (!this.loggedIn) { alert("è¯·å…ˆç™»å½•"); return; }
            this.loading = true;
            try {
              const res = await fetch(`${this.apiBase}/files`, { credentials: "include" });
              const data = await res.json();
              if (!res.ok) { alert(JSON.stringify(data)); return; }
              this.files = data.files || [];
              this.username = data.user || null;
            } catch (e) {
              console.error(e);
              alert("è¯·æ±‚å¤±è´¥");
            } finally {
              this.loading = false;
            }
          },
          async uploadDemo() {
            if (!this.loggedIn) { alert("è¯·å…ˆç™»å½•"); return; }
            this.loading = true;
            try {
              const res = await fetch(`${this.apiBase}/files`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({
                  name: `report-${Date.now()}.pdf`,
                  size: "4KB"
                }),
              });
              const data = await res.json();
              if (!res.ok) { alert(JSON.stringify(data)); return; }
              this.files = data.files || [];
              this.username = data.user || null;
            } catch (e) {
              console.error(e);
              alert("ä¸Šä¼ å¤±è´¥");
            } finally {
              this.loading = false;
            }
          },
          onFileChange(e) {
            const file = e.target.files[0];
            this.realFile = file || null;
            this.realFileName = file ? file.name : "";
          },
          async uploadReal() {
            if (!this.loggedIn) { alert("è¯·å…ˆç™»å½•"); return; }
            if (!this.realFile) { alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶"); return; }
            this.loading = true;
            try {
              const form = new FormData();
              form.append("file", this.realFile);
              const res = await fetch(`${this.apiBase}/files/upload`, {
                method: "POST",
                body: form,
                credentials: "include",
              });
              const data = await res.json();
              if (!res.ok) { alert(JSON.stringify(data)); return; }
              this.files = data.files || [];
              this.username = data.user || null;
              this.realFile = null;
              this.realFileName = "";
            } catch (e) {
              console.error(e);
              alert("çœŸå®æ–‡ä»¶ä¸Šä¼ å¤±è´¥");
            } finally {
              this.loading = false;
            }
          },
          downloadFile(file) {
            if (!file.id) {
              alert("ç¼ºå°‘æ–‡ä»¶ idï¼Œæ— æ³•ä¸‹è½½");
              return;
            }
            const url = `${this.apiBase}/files/download/${encodeURIComponent(file.id)}`;
            window.open(url, "_blank");
          },
          async logout() {
            await fetch(`${this.apiBase}/session/logout`, { 
              method: "POST", 
              credentials: "include" 
            }).catch(() => {});
            
            try {
              await fetch(`${this.authBase}/auth/logout`, { 
                method: "POST", 
                credentials: "include" 
              });
            } catch (_) {
              console.log("ç»Ÿä¸€è®¤è¯é—¨æˆ·æ¸…é™¤ä¼šè¯å¤±è´¥");
            }
            
            this.loggedIn = false;
            this.username = null;
            this.files = [];
          },
          shareUrlFor(f) {
            if (!f.share_token) return "";
            if (f.share_password) {
                return `${this.frontendBase}/share.html?token=${f.share_token}&password=${f.share_password}`;
            } else {
                return `${this.frontendBase}/share.html?token=${f.share_token}`;
            }
          },
          async shareFile(file) {
            if (!this.loggedIn) { alert("è¯·å…ˆç™»å½•"); return; }
            const expireInput = window.prompt("è¯·è¾“å…¥åˆ†äº«æœ‰æ•ˆæœŸï¼ˆå°æ—¶ï¼‰", "24");
            if (expireInput === null) return;
            const expireHours = parseInt(expireInput || "24", 10) || 24;
            const pwd = window.prompt("è®¿é—®å¯†ç ï¼ˆå¯é€‰ï¼ŒåŠ å¯†åˆ†äº«ï¼‰", file.share_password || "");
            this.loading = true;
            try {
                const res = await fetch(`${this.apiBase}/files/share`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({
                        file_id: file.id,
                        expire_hours: expireHours,
                        password: pwd || null,
                    }),
                });
                const data = await res.json();
                if (!res.ok) { alert(JSON.stringify(data)); return; }
                await this.listFiles();
                alert(
                    `åˆ†äº«åˆ›å»ºæˆåŠŸï¼\n\n` +
                    `åˆ†äº«é¡µé¢é“¾æ¥: ${data.share_page_url}\n` +
                    `ç›´æ¥ä¸‹è½½é“¾æ¥: ${data.direct_download_url}\n\n` +
                    (data.need_password ? `è®¿é—®å¯†ç : ${pwd || ""}` : "æ— å¯†ç ä¿æŠ¤")
                );
            } catch (e) {
                console.error(e);
                alert("åˆ›å»ºåˆ†äº«å¤±è´¥");
            } finally {
                this.loading = false;
            }
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>