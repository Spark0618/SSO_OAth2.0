<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>æ–‡ä»¶åˆ†äº« - äº‘ç›˜ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      :root {
        --primary-color: #9A7B9E;
        --primary-light: #C5A8C9;
        --secondary-color: #B8C9B8;
        --accent-color: #E6B89C;
        --background-color: #F9F7F5;
        --card-bg: #FFFFFF;
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --text-primary: #4A4A4A;
        --text-secondary: #7A7A7A;
        --border-color: #E5E0D7;
        --success-color: #88C9A1;
        --error-color: #E6A2A2;
        --warning-color: #E6C9A2;
        --hover-shadow: 0 6px 24px rgba(0, 0, 0, 0.12);
        --transition-speed: 0.3s;
      }

      body {
        font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
        margin: 0;
        background: var(--background-color);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        width: 100%;
        max-width: 500px;
      }

      .card {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 40px;
        box-shadow: var(--card-shadow);
        border: 1px solid var(--border-color);
        transition: all var(--transition-speed) ease;
      }

      .card:hover {
        box-shadow: var(--hover-shadow);
      }

      h1 {
        color: var(--primary-color);
        margin: 0 0 30px 0;
        font-size: 1.8rem;
        font-weight: 600;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }

      h1::before {
        content: "ğŸ”—";
        font-size: 2rem;
      }

      .loading {
        text-align: center;
        padding: 40px 0;
      }

      .loading-spinner {
        display: inline-block;
        width: 50px;
        height: 50px;
        border: 3px solid rgba(154, 123, 158, 0.2);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 20px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .status-message {
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 24px;
        text-align: center;
        font-weight: 500;
      }

      .error {
        background: rgba(230, 162, 162, 0.1);
        border: 1px solid rgba(230, 162, 162, 0.3);
        color: var(--error-color);
      }

      .file-preview {
        background: linear-gradient(135deg, rgba(154, 123, 158, 0.05), rgba(184, 201, 184, 0.05));
        border-radius: 16px;
        padding: 30px;
        text-align: center;
        margin-bottom: 24px;
        border: 2px dashed rgba(154, 123, 158, 0.2);
      }

      .file-icon {
        font-size: 64px;
        margin-bottom: 20px;
        color: var(--primary-color);
      }

      .file-name {
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 10px;
        word-break: break-word;
      }

      .file-meta {
        color: var(--text-secondary);
        font-size: 14px;
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
      }

      .info-card {
        background: rgba(184, 201, 184, 0.08);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        border: 1px solid rgba(184, 201, 184, 0.3);
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        margin: 12px 0;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(184, 201, 184, 0.2);
      }

      .info-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .label {
        color: var(--text-secondary);
        font-weight: 500;
      }

      .value {
        color: var(--text-primary);
        font-weight: 600;
      }

      .expiry-warning {
        background: rgba(230, 201, 162, 0.15);
        border: 1px solid rgba(230, 201, 162, 0.4);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 24px;
        color: var(--warning-color);
        text-align: center;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .expiry-warning::before {
        content: "âš ï¸";
      }

      .password-section {
        background: rgba(154, 123, 158, 0.05);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        border: 1px solid rgba(154, 123, 158, 0.2);
      }

      .password-section h3 {
        color: var(--primary-color);
        margin: 0 0 16px 0;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .password-section h3::before {
        content: "ğŸ”’";
      }

      input {
        width: 100%;
        padding: 14px 18px;
        border-radius: 10px;
        border: 2px solid var(--border-color);
        background: var(--card-bg);
        color: var(--text-primary);
        font-size: 16px;
        box-sizing: border-box;
        transition: all var(--transition-speed) ease;
        margin-bottom: 16px;
      }

      input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(154, 123, 158, 0.1);
      }

      button {
        width: 100%;
        padding: 16px 24px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 12px;
        border: none;
        cursor: pointer;
        transition: all var(--transition-speed) ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
        box-shadow: 0 4px 12px rgba(154, 123, 158, 0.3);
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(154, 123, 158, 0.4);
      }

      .btn-secondary {
        background: linear-gradient(135deg, var(--secondary-color), #D4E4D4);
        color: var(--text-primary);
        box-shadow: 0 4px 12px rgba(184, 201, 184, 0.3);
        margin-top: 16px;
      }

      .btn-secondary:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(184, 201, 184, 0.4);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
      }

      .success-message {
        background: rgba(136, 201, 161, 0.1);
        border: 1px solid rgba(136, 201, 161, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        color: var(--success-color);
        text-align: center;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .success-message::before {
        content: "âœ…";
      }

      .link-info {
        background: rgba(154, 123, 158, 0.05);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 24px;
        border: 1px solid rgba(154, 123, 158, 0.2);
        font-size: 14px;
      }

      .link-info a {
        color: var(--primary-color);
        text-decoration: none;
        word-break: break-all;
      }

      .link-info a:hover {
        text-decoration: underline;
      }

      footer {
        text-align: center;
        margin-top: 32px;
        color: var(--text-secondary);
        font-size: 14px;
      }

      .back-link {
        display: inline-block;
        margin-top: 16px;
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
        transition: color var(--transition-speed) ease;
      }

      .back-link:hover {
        color: var(--primary-light);
        text-decoration: underline;
      }

      .encrypted-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: rgba(154, 123, 158, 0.1);
        color: var(--primary-color);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
      }

      .encrypted-badge::before {
        content: "ğŸ”";
      }

      @media (max-width: 600px) {
        body {
          padding: 16px;
        }
        
        .card {
          padding: 24px;
        }
        
        h1 {
          font-size: 1.5rem;
        }
        
        .file-preview {
          padding: 20px;
        }
        
        .file-icon {
          font-size: 48px;
        }
      }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div class="card">
            <h1>æ–‡ä»¶åˆ†äº«</h1>
            
            <div v-if="loading" class="loading">
                <div class="loading-spinner"></div>
                <p>æ­£åœ¨åŠ è½½åˆ†äº«ä¿¡æ¯...</p>
            </div>

            <div v-else-if="error" class="status-message error">
                <p>{{ error }}</p>
                <a href="https://cloud.localhost:4176/cloud.html" class="back-link">è¿”å›äº‘ç›˜</a>
            </div>

            <div v-else-if="fileInfo">
                <!-- æ–‡ä»¶é¢„è§ˆ -->
                <div class="file-preview">
                    <div class="file-icon">
                        {{ getFileIcon(fileInfo.name) }}
                    </div>
                    <div class="file-name">
                        {{ fileInfo.name }}
                        <span v-if="fileInfo.encrypted" class="encrypted-badge">åŠ å¯†</span>
                    </div>
                    <div class="file-meta">
                        <span>å¤§å°: {{ fileInfo.size }}</span>
                        <span>ä¸Šä¼ : {{ formatDate(fileInfo.uploaded_at) }}</span>
                    </div>
                </div>

                <!-- æ–‡ä»¶ä¿¡æ¯ -->
                <div class="info-card">
                    <div class="info-row">
                        <span class="label">åˆ†äº«è€…</span>
                        <span class="value">{{ fileInfo.owner }}</span>
                    </div>
                    <div class="info-row">
                         <span class="label">åˆ†äº«æ—¶é—´</span>
                         <span class="value">{{ formatDateTime(fileInfo.shared_created_at || fileInfo.uploaded_at) }}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">æœ‰æ•ˆæœŸè‡³</span>
                        <span class="value">{{ formatDate(fileInfo.share_expires_at) }}</span>
                    </div>
                </div>

                <!-- è¿‡æœŸè­¦å‘Š -->
                <div v-if="isExpired" class="expiry-warning">
                    æ­¤åˆ†äº«é“¾æ¥å·²è¿‡æœŸ
                </div>

                <!-- å¯†ç è¾“å…¥ -->
                <div v-if="needPassword && !passwordEntered" class="password-section">
                    <h3>è¯·è¾“å…¥è®¿é—®å¯†ç </h3>
                    <input 
                        type="password" 
                        v-model="password" 
                        placeholder="è¾“å…¥åˆ†äº«å¯†ç " 
                        @keyup.enter="verifyPassword"
                        :disabled="verifying"
                    />
                    <button 
                        class="btn-primary" 
                        @click="verifyPassword"
                        :disabled="!password || verifying"
                    >
                        <span v-if="verifying" class="loading-spinner" style="width: 20px; height: 20px; border-width: 2px;"></span>
                        <span v-else>ğŸ” éªŒè¯å¯†ç </span>
                    </button>
                </div>

                <!-- ä¸‹è½½åŒºåŸŸ -->
                <div v-if="canDownload">
                    <div class="success-message" v-if="passwordEntered">
                        å¯†ç éªŒè¯æˆåŠŸï¼æ‚¨ç°åœ¨å¯ä»¥ä¸‹è½½æ–‡ä»¶äº†ã€‚
                    </div>
                    
                    <div class="link-info" v-if="fileInfo.download_url">
                        <strong>ä¸‹è½½é“¾æ¥ï¼š</strong><br>
                        <a :href="fileInfo.download_url" target="_blank">{{ fileInfo.download_url }}</a>
                    </div>

                    <button class="btn-primary" @click="downloadFile">
                        â¬‡ï¸ ä¸‹è½½æ–‡ä»¶
                    </button>
                    
                    <a href="https://cloud.localhost:4176/cloud.html" class="back-link">
                        è¿”å›æˆ‘çš„äº‘ç›˜
                    </a>
                </div>

                <footer>
                    <p>äº‘ç›˜ç³»ç»Ÿ Â· å®‰å…¨åˆ†äº«</p>
                    <p v-if="fileInfo.shared_via" style="font-size: 12px; opacity: 0.7;">åˆ†äº«ID: {{ fileInfo.shared_via }}</p>
                </footer>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    apiBase: "https://cloud.localhost:5002",
                    loading: true,
                    error: null,
                    fileInfo: null,
                    password: "",
                    passwordEntered: false,
                    verifying: false,
                    shareToken: null,
                    urlPassword: null
                };
            },
            computed: {
                needPassword() {
                    return this.fileInfo && this.fileInfo.encrypted;
                },
                canDownload() {
                    if (!this.fileInfo) return false;
                    if (this.isExpired) return false;
                    if (this.needPassword && !this.passwordEntered) return false;
                    return this.fileInfo.is_binary === true;
                },
                isExpired() {
                    if (!this.fileInfo || !this.fileInfo.share_expires_at) return false;
                    const expiry = new Date(this.fileInfo.share_expires_at);
                    return expiry < new Date();
                }
            },
            mounted() {
                this.loadShareInfo();
            },
            methods: {
                async loadShareInfo() {
                    try {
                        const urlParams = new URLSearchParams(window.location.search);
                        this.shareToken = urlParams.get('token');
                        this.urlPassword = urlParams.get('password');
                        
                        if (!this.shareToken) {
                            this.error = "åˆ†äº«é“¾æ¥æ— æ•ˆï¼Œç¼ºå°‘tokenå‚æ•°";
                            this.loading = false;
                            return;
                        }
                        
                        let apiUrl = `${this.apiBase}/share/${this.shareToken}`;
                        if (this.urlPassword) {
                            apiUrl += `?password=${encodeURIComponent(this.urlPassword)}`;
                        }
                        
                        const response = await fetch(apiUrl, {
                            method: "GET",
                            mode: "cors",
                            credentials: "include",
                            headers: {
                                "Accept": "application/json",
                                "Content-Type": "application/json"
                            }
                        });
                        
                        if (response.status === 404) {
                            this.error = "åˆ†äº«é“¾æ¥ä¸å­˜åœ¨æˆ–å·²å¤±æ•ˆ";
                            this.loading = false;
                            return;
                        } else if (response.status === 410) {
                            this.error = "åˆ†äº«å·²è¿‡æœŸ";
                            this.loading = false;
                            return;
                        } else if (response.status === 403) {
                            this.error = "å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥";
                            this.loading = false;
                            return;
                        } else if (!response.ok) {
                            this.error = `æœåŠ¡å™¨é”™è¯¯: HTTP ${response.status}`;
                            this.loading = false;
                            return;
                        }
                        
                        const data = await response.json();
                        if (data.error) {
                            this.error = data.error;
                            this.loading = false;
                            return;
                        }
                        
                        this.fileInfo = data;
                        
                        if (this.urlPassword && this.needPassword) {
                            this.password = this.urlPassword;
                            this.passwordEntered = true;
                            this.addDownloadUrl();
                        }
                        
                    } catch (err) {
                        console.error("åŠ è½½åˆ†äº«ä¿¡æ¯å¤±è´¥:", err);
                        if (err.name === 'TypeError' && err.message.includes('fetch')) {
                            this.error = "ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIæœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ";
                        } else {
                            this.error = `è¯·æ±‚å¤±è´¥: ${err.message}`;
                        }
                    } finally {
                        this.loading = false;
                    }
                },
                
                async verifyPassword() {
                    if (!this.password) {
                        this.error = "è¯·è¾“å…¥å¯†ç ";
                        return;
                    }
                    
                    this.verifying = true;
                    this.error = null;
                    
                    try {
                        const apiUrl = `${this.apiBase}/share/${this.shareToken}?password=${encodeURIComponent(this.password)}`;
                        
                        const response = await fetch(apiUrl, {
                            method: "GET",
                            mode: "cors",
                            headers: {
                                "Accept": "application/json"
                            }
                        });
                        
                        if (response.status === 403) {
                            this.error = "å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥";
                            return;
                        } else if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            this.error = errorData.error || `éªŒè¯å¤±è´¥: HTTP ${response.status}`;
                            return;
                        }
                        
                        const data = await response.json();
                        this.passwordEntered = true;
                        this.fileInfo = data;
                        this.error = null;
                        
                        this.updateUrlWithPassword();
                        this.addDownloadUrl();
                        
                    } catch (err) {
                        console.error("å¯†ç éªŒè¯å¤±è´¥:", err);
                        this.error = "éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•";
                    } finally {
                        this.verifying = false;
                    }
                },
                
                addDownloadUrl() {
                    if (this.fileInfo && this.fileInfo.is_binary) {
                        this.fileInfo.download_url = `${this.apiBase}/share/${this.shareToken}/download?password=${encodeURIComponent(this.password)}`;
                    }
                },
                
                updateUrlWithPassword() {
                    const url = new URL(window.location);
                    url.searchParams.set('password', this.password);
                    window.history.replaceState({}, '', url);
                },
                
                async downloadFile() {
                    if (!this.fileInfo.download_url) {
                        this.error = "ä¸‹è½½é“¾æ¥æ— æ•ˆ";
                        return;
                    }
                    
                    try {
                        const link = document.createElement('a');
                        link.href = this.fileInfo.download_url;
                        link.download = this.fileInfo.name;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        this.showMessage("æ–‡ä»¶ä¸‹è½½å·²å¼€å§‹", "success");
                        
                    } catch (err) {
                        console.error("ä¸‹è½½å¤±è´¥:", err);
                        this.error = "ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•";
                    }
                },
                
                getFileIcon(filename) {
                    const ext = filename.split('.').pop().toLowerCase();
                    const icons = {
                        'pdf': 'ğŸ“•',
                        'doc': 'ğŸ“',
                        'docx': 'ğŸ“',
                        'txt': 'ğŸ“„',
                        'jpg': 'ğŸ–¼ï¸',
                        'jpeg': 'ğŸ–¼ï¸',
                        'png': 'ğŸ–¼ï¸',
                        'zip': 'ğŸ“¦',
                        'rar': 'ğŸ“¦',
                        'mp3': 'ğŸµ',
                        'mp4': 'ğŸ¬',
                        'exe': 'âš™ï¸',
                        'xls': 'ğŸ“Š',
                        'xlsx': 'ğŸ“Š'
                    };
                    return icons[ext] || 'ğŸ“';
                },
                
                formatDate(dateString) {
                    if (!dateString) return 'æœªçŸ¥';
                    const date = new Date(dateString);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },
                
                formatDateTime(dateString) {
                    if (!dateString) return 'æœªçŸ¥';
                    const date = new Date(dateString);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                },
                
                showMessage(message, type = 'success') {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `status-message ${type === 'success' ? 'success-message' : 'error'}`;
                    messageDiv.textContent = message;
                    messageDiv.style.position = 'fixed';
                    messageDiv.style.top = '20px';
                    messageDiv.style.right = '20px';
                    messageDiv.style.zIndex = '1000';
                    messageDiv.style.maxWidth = '300px';
                    
                    document.body.appendChild(messageDiv);
                    
                    setTimeout(() => {
                        document.body.removeChild(messageDiv);
                    }, 3000);
                }
            }
        }).mount("#app");
    </script>
</body>
</html>